# CAP

<!-- TOC -->

- [CAP](#cap)
    - [CAP是什么](#cap%E6%98%AF%E4%BB%80%E4%B9%88)
    - [CA、CP、AP](#cacpap)
    - [CAP 理论的证明](#cap-%E7%90%86%E8%AE%BA%E7%9A%84%E8%AF%81%E6%98%8E)
    - [CAP 理论澄清](#cap-%E7%90%86%E8%AE%BA%E6%BE%84%E6%B8%85)
    - [ACID、BASE、CAP](#acidbasecap)

<!-- /TOC -->

## CAP是什么

> CAP理论，被戏称为[帽子理论]。CAP理论由Eric Brewer在2000年ACM研讨会上提出，而后CAP被奉为分布式领域的重要理论[1] 。

- 一致性(C): 在分布式系统中的所有数据备份，在同一时刻是否同样的值。(等同于所有节点访问同一份最新的数据副本)
- 可用性(A): 在集群中一部分节点故障后，集群整体是否还能响应客户端 的读写请求。(对数据更新具备高可用性)
- 分区容忍性(P): 以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。(分区状态可以理解为部分机器不连通了，比如机器挂了，繁忙失去响应，单机房故障等)

Partition 字面意思是网络分区，即因网络因素将系统分隔为多个单独的部 分，有人可能会说，网络分区的情况发生概率非常小啊，是不是不用考虑 P， 保证 CA 就好。要理解 P，我们看回 CAP 证明中 P 的定义:

> In order to model partition tolerance, the network will be allowed to lose arbitrarily many messages sent from one node to another。

网络分区的情况符合该定义，网络丢包的情况也符合以上定义，另外节点宕机，其他节点发往宕机节点的包也将丢失，这种情况同样符合定义。现实情况下我们面对的是一个不可靠的网络、有一定概率宕机的设备，这两个因素都会 导致 Partition，因而分布式系统实现中 P 是一个必须项，而不是可选项。

## CA、CP、AP
高可用、数据一致性是很多系统设计的目标，但是分区又是不可避免的事情。 我们来看一看分别拥有 CA、CP 和 AP 的情况。


- CA without P：  
如果不要求 P(不允许分区)，则 C(强一致性)和 A(可用 性)是可以保证的。
但其实分区不是你想不想的问题，而是始终会存在，CA 系 统基本上是**单机系统**，比如单机数据库。2PC 是实现强一致性的具体手段。

- CP without A:如果不要求 A(可用)，相当于每个请求都需要在 Server 之间 强一致，而 P(分区)会导致同步时间无限延长，如此 CP 也是可以保证的。很 多传统的数据库分布式事务都属于这种模式。

- AP wihtout C:要高可用并允许分区，则需放弃一致性。一旦分区发生，节点 之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。现在众多的 NoSQL 都属于此类。

## CAP 理论的证明

- C:一致性被称为原子对象，任何的读写都应该看起来是 “原子“的，或串行的。写后面的读一定能读到前面写的内容。所有的读写请 求都好像被全局排序一样。
- A:对任何非失败节点都应该在有限时间内给出请求的回 应。(请求的可终止性)
- P:允许节点之间丢失任意多的消息，当网络分区发生时， 节点之间的消息可能会完全丢失。

对于 CAP 进一步的案例解释
2010 年的这篇文章 brewers-cap-theorem-on-distributed-systems/，用了三个例子来阐述 CAP，分别是
- example1: 单点的 mysql;
- example2: 两个 mysql， 但不同的 mysql 存储不同的数据子集,相当于sharding;
- example3: 两个 mysql，对 A 的一个 insert 操作，需要在 B 上执行成功才认为操作完成(类似复制集)。

作者认为在 example1 和 example2 上都能保证强一致性，但不能保证可用性;

在 example3 这个例子，由于分区(partition)的存在，就需要在一致性与可用性之间权衡。

对于复制而言，在很多场景下不追求强一致性。比如用户支付之后，交易记录落地了; 但可能消费记录的消息同步存在延迟，比如消息阻塞了。

在金融业务中，采取类似两地三中心架构，往往可能采取本地数据和异地机房数据同时写成功再返回的方式。这样付出了性能的损耗，响应时间变长。但发生机房故障后，能确保数据是完全可以读写的，保障了一致性。

## CAP 理论澄清


“三选二”是一个伪命题

不是为了 P(分区容忍性)，要在 A 和 C 之间选择一个。分区很少出现，CAP 在大多数时候允许完美的 C 和 A。但当分区存在或可感知其影响的情况下，就要预备一种策略去探知分区并显式处理其影响。这样的策略应分为三个步骤:
探知分区发生，
进入显式的分区模式以限制某些操作，
启动恢复过程以恢复数据一致性并补偿分区期间发生的错误。

“一致性的作用范围”其实反映了这样一种观念，即在一定的边界内状态是一 致的，但超出了边界就无从谈起。
比如在一个主分区内可以保证完备的一致性和可用性，而在分区外服务是不可用的。

Paxos 算法和原子性多播(atomic multicast)系统一般符合这样的场景。像 Google 的一般做法是将主分区归属 在单个数据中心里面，然后交给 Paxos 算法去解决跨区域的问题，一方面保证 全局协商一致(global consensus)如 Chubby，一方面实现高可用的持久性存 储如 Megastore。



## ACID、BASE、CAP

ACID 和 BASE 这两个术语都好记有余而精确不足，出现较晚的 BASE 硬凑的感觉更明显，它是“Basically Available, Soft state, Eventually consistent (基本可用、软状态、最终一致性)”的首字母缩写。其中的软状态和最终一致性这两种技巧擅于对付存在分区的场合，并因此高了可用性。  

CAP 与 ACID 的关系更复杂一些，也因此引起更多误解。其中一个原因是 ACID 的 C 和 A 字母所代表的概念不同于 CAP 的 C 和 A。还有一个原因是选择可用性只部分地影响 ACID 约束。
